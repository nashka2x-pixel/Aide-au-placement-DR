<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1" />
<link rel="manifest" href="manifest.json" />
<title>Gestion ‚Äî Colonnes Phoenix</title>

<style>
  *{ box-sizing:border-box; margin:0; padding:0; }
  html, body{ touch-action: manipulation; }

  /* --- ajouts anti s√©lection / callout / highlight --- */
  html, body, .tower, .dot, .btn, .pill, .bigBtn, .badge, .remain, .wm, .signature {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }
  *, *::before, *::after { -webkit-tap-highlight-color: transparent; }
  /* --------------------------------------------------- */

  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: url("https://i.postimg.cc/Hk73V0DG/24395a4f-257e-43f9-8c2f-52702e2c1dc6.png") no-repeat center center fixed;
    background-size: cover;
    color:#f0f1f4;
    min-height:100vh; display:flex; flex-direction:column; gap:10px; padding:10px;
    user-select:none;
  }

  /* Toolbar */
  .toolbar{
    max-width: 980px; width:100%; margin:0 auto;
    display:flex; align-items:center; justify-content:center; gap:10px;
  }
  .badge{
    font-size:18px; font-weight:800; padding:10px 14px; border-radius:12px;
    background:rgba(20,20,26,.65); color:#ffd9c0; box-shadow:0 4px 10px rgba(0,0,0,.35);
    min-width:120px; height:44px; display:flex; align-items:center; justify-content:center;
    border:1px solid rgba(255,140,0,.25);
  }
  .btn{
    font-size:16px; padding:10px 14px; border:none; border-radius:12px; cursor:pointer;
    min-width:120px; height:44px; display:flex; align-items:center; justify-content:center;
    font-weight:800; box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,0,0,.2);
  }
  .btn.red{ background:#e63946; color:#ffeae6; }
  .btn.yellow{ background:#ffcb3c; color:#1b0e07; }

  /* Grille colonnes */
  .hall{
    max-width: 980px; width:100%; margin:0 auto; flex:1;
    display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:18px;
    align-items:start;
  }

  .tower{
    position:relative; display:flex; flex-direction:column; align-items:center;
    background: rgba(18,18,22,.88);
    border:1px solid rgba(255,140,0,.22); border-radius:14px;
    box-shadow:0 10px 24px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.04);
    /* ‚Üë plus d‚Äôespace en bas pour √©viter chevauchement */
    padding: 140px 12px 190px;
    min-height: 78vh;
    overflow:hidden; cursor:pointer; backdrop-filter: blur(2px);
  }
  .tower.short{ min-height: 72vh; }

  /* Watermark */
  .wm{
    position:absolute; top:12px; left:50%; transform:translateX(-50%);
    font-weight:900; font-size: clamp(72px, 12.5vh, 132px);
    color: rgba(255, 184, 77, .55);
    z-index:3; line-height:1; user-select:none; pointer-events:none;
  }

  /* Rails de points */
  .rails{ flex:1; width:100%; display:flex; justify-content:space-evenly; align-items:flex-start; padding-bottom:32px; }
  .rail{ display:flex; flex-direction:column; gap:26px; }
  .rail.right{ margin-top:20px; } /* quinconce */

  /* Points */
  .dot{
    width:40px; height:40px; border-radius:50%;
    box-shadow: inset 0 0 0 2px rgba(0,0,0,.3), 0 2px 6px rgba(0,0,0,.45);
    touch-action:none; position:relative; z-index:1;
  }
  .dot.free{ background:#00ff6a; }
  .dot.taken{ background:#8a8f98; }
  .dot.reserved-switch{ background:#cc6600; } /* Switch orange fonc√© */
  .dot.reserved-pmr{ background:#3da5ff; }    /* PMR bleu */
  .dot.broken{ background:#ff3333; }

  /* "Places : XX" */
  .remain{
    position:absolute; left:14px; right:14px; bottom:175px;
    display:flex; align-items:flex-end; justify-content:center; gap:10px; z-index:2;
    color:#ffd54a;
  }
  .remain .label{ font-size:18px; font-weight:700; line-height:1.2; opacity:.95; }
  .remain .num{ font-size:40px; font-weight:900; line-height:1; }

  /* Bouton ‚Äì */
  .minus{
    position:absolute; left:12px; right:12px; bottom:16px; height:96px;
    border:none; border-radius:12px; background:#e63946; color:#ffeae6;
    font-weight:900; font-size:42px; line-height:1;
    box-shadow:0 10px 24px rgba(0,0,0,.55); cursor:pointer;
    z-index:4; /* passe au-dessus des points */
  }

  /* --------- MODAL R√©server --------- */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:18px; z-index:50; }
  .modal{
    width:min(560px,96vw); max-height:90vh; overflow:auto; background:#121216; color:#f0f1f4;
    border-radius:16px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.55); border:1px solid rgba(255,140,0,.25);
  }
  .modal h2{ margin:0 0 12px; font-size:22px; color:#ffd28a; }
  .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
  .btn.light{ background:#1e1f25; color:#ffd5a8; border:1px solid rgba(255,140,0,.25); }

  .reserve-choices{ display:flex; gap:12px; margin:10px 0 14px; }
  .pill{
    flex:1; display:flex; align-items:center; justify-content:center;
    height:110px; border:3px solid transparent; border-radius:18px;
    font-size:22px; font-weight:900; cursor:pointer; user-select:none;
    background:#1f2128; color:#ffd9c0; transition:.15s;
  }
  .pill.active[data-type="switch"]{ background:#2b200f; border-color:#cc6600; box-shadow:0 0 0 4px rgba(204,102,0,.35) inset; }
  .pill.active[data-type="pmr"]{ background:#182130; border-color:#3da5ff; box-shadow:0 0 0 4px rgba(61,165,255,.25) inset; }

  .stepperWrap{ display:flex; justify-content:center; margin-top:6px; }
  .stepper{ display:flex; align-items:center; gap:14px; }
  .bigBtn{ font-size:28px; font-weight:900; width:72px; height:72px; border-radius:16px; border:none; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,.35); }
  .bigMinus{ background:#2b1a1a; color:#ffb3b3; }
  .bigPlus{ background:#1f2a1f; color:#b8ffc8; }
  .countDisplay{ min-width:90px; text-align:center; font-size:36px; font-weight:900; color:#ffd9c0; }

  /* Signature */
  .signature{
    text-align:center; margin-top:6px; color:#ffe66d; font-weight:700; font-size:18px;
    font-style: italic;
    font-family: "Segoe Script", "Brush Script MT", "Lucida Handwriting", "Snell Roundhand", cursive;
  }

  /* Responsive */
  @media (max-width: 900px){
    .dot{ width:34px; height:34px; }
    .rail{ gap:20px; }
    .tower{ padding:130px 10px 185px; min-height: 76vh; }
    .tower.short{ min-height: 70vh; }
    .remain{ bottom:175px; }
    .remain .num{ font-size:36px; }
    .minus{ height:88px; font-size:38px; }
  }
  @media (max-width: 700px){
    .dot{ width:30px; height:30px; }
    .rail{ gap:16px; }
    .tower{ padding:120px 8px 190px; min-height: 74vh; }
    .tower.short{ min-height: 68vh; }
    .remain{ bottom:180px; }
    .remain .num{ font-size:32px; }
    .minus{ height:80px; font-size:36px; }
  }
</style>
</head>
<body>
  <div class="toolbar">
    <span class="badge" id="summaryMini">-- / --</span>
    <button class="btn red" id="resetBtn">üîÑ S√©ance</button>
    <button class="btn yellow" id="reserveBtn">üéüÔ∏è R√©server</button>
  </div>

  <main class="hall" id="hall"></main>

  <div class="signature">By Edithe ‚ô•</div>

  <!-- Modal R√©server -->
  <div class="modal-backdrop" id="modalReserve" role="dialog" aria-modal="true" aria-labelledby="reserveTitle">
    <div class="modal">
      <h2 id="reserveTitle">R√©server pour la prochaine s√©ance</h2>
      <div class="reserve-choices">
        <button class="pill active" data-type="switch">üë∂ Switch</button>
        <button class="pill" data-type="pmr">‚ôø PMR</button>
      </div>
      <div class="stepperWrap">
        <div class="stepper">
          <button class="bigBtn bigMinus" id="decBtn">‚àí</button>
          <div class="countDisplay" id="reserveCount">1</div>
          <button class="bigBtn bigPlus" id="incBtn">+</button>
        </div>
      </div>
      <div class="actions">
        <button class="btn light" id="reserveCancel">Annuler</button>
        <button class="btn yellow" id="reserveConfirm">R√©server</button>
      </div>
    </div>
  </div>

<script>
  // Capacit√©s (gauche ‚Üí droite)
  const CAPS=[10,12,14,14], COLS=CAPS.length, TOTAL_CAP=CAPS.reduce((a,b)=>a+b,0);

  // √âtats (persistance)
  let counts          = load('phoenix_counts',          Array(COLS).fill(0));
  let reservedActS    = load('phoenix_reserved_actS',   Array(COLS).fill(0)); // Switch (actifs)
  let reservedActP    = load('phoenix_reserved_actP',   Array(COLS).fill(0)); // PMR (actifs)
  let reservedNextS   = load('phoenix_reserved_nextS',  Array(COLS).fill(0)); // Switch (√† appliquer)
  let reservedNextP   = load('phoenix_reserved_nextP',  Array(COLS).fill(0)); // PMR (√† appliquer)
  let broken          = load('phoenix_broken',          CAPS.map(c=>Array(c).fill(false)));

  function load(k,f){ try{const r=localStorage.getItem(k); return r?JSON.parse(r):f;}catch{return f;} }
  function save(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch{} }

  const hall=document.getElementById('hall');
  const summary=document.getElementById('summaryMini');

  // Ordre de peinture top-left ‚Üí top-right ‚Üí rang√©e suivante
  const dotRefs = Array.from({length:COLS},()=>[]);
  // Anti-bug post long-press : horodatage par colonne
  const lastLongPressTs = Array(COLS).fill(0);

  // Construction colonnes
  for(let i=0;i<COLS;i++){
    const tower=document.createElement('div');
    tower.className='tower'+(i<2?' short':''); tower.dataset.i=i;

    const wm=document.createElement('div'); wm.className='wm'; wm.textContent=String(i+1); tower.appendChild(wm);

    const rails=document.createElement('div'); rails.className='rails';
    const left=document.createElement('div'); left.className='rail left';
    const right=document.createElement('div'); right.className='rail right';

    const total=CAPS[i], rows=Math.ceil(total/2); let idx=0;
    for(let r=0;r<rows;r++){
      if(idx<total){ const d=makeDot(i,idx); left.appendChild(d); dotRefs[i].push(d); idx++; }
      if(idx<total){ const d=makeDot(i,idx); right.appendChild(d); dotRefs[i].push(d); idx++; }
    }
    rails.append(left,right); tower.appendChild(rails);

    const remain=document.createElement('div'); remain.className='remain'; remain.id=`remain-${i}`;
    remain.innerHTML = `<div class="label">Places :</div><div class="num">--</div>`;
    tower.appendChild(remain);

    tower.addEventListener('click', ()=>{
      if(Date.now() - lastLongPressTs[i] < 400) return; // ignore le tap juste apr√®s un long-press
      add(i);
    });

    const minus=document.createElement('button'); minus.className='minus'; minus.textContent='‚àí';
    minus.addEventListener('click', e=>{ e.stopPropagation(); remove(i); });
    tower.appendChild(minus);

    hall.appendChild(tower);
  }

  function makeDot(col,idx){
    const d=document.createElement('div');
    d.className='dot '+(broken[col][idx]?'broken':'free');
    d.dataset.idx=idx;

    // Un tap sur un point = ajout (sauf juste apr√®s long-press)
    d.addEventListener('click', e=>{
      e.stopPropagation();
      if(Date.now() - lastLongPressTs[col] < 400) return;
      add(col);
    });
    d.addEventListener('contextmenu', e=>e.preventDefault());

    // Long-press pour panne (‚âà850 ms)
    let timer=null;
    const start = ()=>{ timer=setTimeout(()=>{ toggleBroken(col,idx); lastLongPressTs[col]=Date.now(); }, 850); };
    const end   = ()=>{ clearTimeout(timer); };

    d.addEventListener('mousedown', e=>{ e.stopPropagation(); start(); });
    d.addEventListener('mouseup', end);
    d.addEventListener('mouseleave', end);

    d.addEventListener('touchstart', e=>{ start(); }, {passive:true});
    d.addEventListener('touchend', end);
    d.addEventListener('touchcancel', end);

    return d;
  }

  function toggleBroken(c,i){
    broken[c][i]=!broken[c][i];
    save('phoenix_broken', broken);
    render();
  }

  const brokenCount = (i)=> broken[i].filter(Boolean).length;
  const activeRes   = (i)=> reservedActS[i] + reservedActP[i];
  const freeSlots   = (i)=> Math.max(0, CAPS[i]-activeRes(i)-counts[i]-brokenCount(i));

  function add(i){ if(freeSlots(i)>0){ counts[i]++; save('phoenix_counts',counts); render(); } }
  function remove(i){ if(counts[i]>0){ counts[i]--; save('phoenix_counts',counts); render(); } }

  function updateSummary(){
    let used=0;
    for(let i=0;i<COLS;i++) used += activeRes(i)+counts[i]+brokenCount(i);
    summary.textContent = `${Math.max(0, TOTAL_CAP-used)} / ${TOTAL_CAP}`;
  }

  function render(){
    for(let i=0;i<COLS;i++){
      const arr=dotRefs[i];
      // base: free/broken
      arr.forEach((d,idx)=>{ d.className='dot '+(broken[i][idx]?'broken':'free'); });
      // r√©serv√©s SWITCH (orange fonc√©) puis PMR (bleu)
      let rs=reservedActS[i];
      for(let k=0;k<arr.length && rs>0;k++){
        if(broken[i][k]) continue;
        if(arr[k].classList.contains('free')){ arr[k].className='dot reserved-switch'; rs--; }
      }
      let rp=reservedActP[i];
      for(let k=0;k<arr.length && rp>0;k++){
        if(broken[i][k]) continue;
        if(arr[k].classList.contains('free')){ arr[k].className='dot reserved-pmr'; rp--; }
      }
      // pris (gris)
      let t=counts[i];
      for(let k=0;k<arr.length && t>0;k++){
        if(broken[i][k]) continue;
        if(arr[k].classList.contains('free')){ arr[k].className='dot taken'; t--; }
      }
      // places affich√©es
      const remainEl = document.getElementById(`remain-${i}`);
      remainEl.querySelector('.num').textContent = String(freeSlots(i));
    }
    updateSummary();
  }

  // Nouvelle s√©ance : applique les r√©servations "next" (col 1 puis col 2)
  function resetAll(){
    counts = Array(COLS).fill(0); save('phoenix_counts',counts);
    reservedActS = Array(COLS).fill(0);
    reservedActP = Array(COLS).fill(0);

    let toS = reservedNextS.reduce((a,b)=>a+b,0);
    let toP = reservedNextP.reduce((a,b)=>a+b,0);

    const cap0 = CAPS[0] - brokenCount(0);
    const cap1 = CAPS[1] - brokenCount(1);

    // D'abord SWITCH
    reservedActS[0] = Math.min(toS, cap0);
    toS -= reservedActS[0];
    reservedActS[1] = Math.min(toS, Math.max(0, cap1 - reservedActS[1]));
    toS -= reservedActS[1];

    // Puis PMR
    const rest0 = cap0 - reservedActS[0];
    const rest1 = cap1 - reservedActS[1];
    reservedActP[0] = Math.min(toP, rest0); toP -= reservedActP[0];
    reservedActP[1] = Math.min(toP, rest1); toP -= reservedActP[1];

    reservedNextS = Array(COLS).fill(0);
    reservedNextP = Array(COLS).fill(0);
    save('phoenix_reserved_actS', reservedActS);
    save('phoenix_reserved_actP', reservedActP);
    save('phoenix_reserved_nextS', reservedNextS);
    save('phoenix_reserved_nextP', reservedNextP);

    render();
  }

  /* ----- R√©server ----- */
  const modalReserve = document.getElementById('modalReserve');
  const reserveBtn = document.getElementById('reserveBtn');
  const reserveCancel = document.getElementById('reserveCancel');
  const reserveConfirm = document.getElementById('reserveConfirm');
  const decBtn = document.getElementById('decBtn');
  const incBtn = document.getElementById('incBtn');
  const reserveCountDisplay = document.getElementById('reserveCount');
  let reserveType='switch', reserveQty=1;

  function openReserve(){
    reserveType='switch'; reserveQty=1; updateReserveCount();
    document.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.type==='switch'));
    modalReserve.style.display='flex';
  }
  function closeReserve(){ modalReserve.style.display='none'; }
  function updateReserveCount(){ reserveCountDisplay.textContent=String(reserveQty); }

  document.querySelectorAll('.pill').forEach(p=>{
    p.addEventListener('click',()=>{
      document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      reserveType=p.dataset.type;
    });
  });
  decBtn.addEventListener('click', ()=>{ reserveQty=Math.max(1,reserveQty-1); updateReserveCount(); });
  incBtn.addEventListener('click', ()=>{ reserveQty=Math.max(1,reserveQty+1); updateReserveCount(); });

  reserveBtn.addEventListener('click', openReserve);
  reserveCancel.addEventListener('click', closeReserve);
  modalReserve.addEventListener('click', e=>{ if(e.target===modalReserve) closeReserve(); });

  reserveConfirm.addEventListener('click', ()=>{
    const n=reserveQty;
    if(reserveType==='switch'){ reservedNextS[0]+=n; } else { reservedNextP[0]+=n; }
    save('phoenix_reserved_nextS', reservedNextS);
    save('phoenix_reserved_nextP', reservedNextP);
    closeReserve();
  });

  // Bouton S√©ance
  document.getElementById('resetBtn').addEventListener('click', resetAll);

  // Anti-zoom propre
  document.addEventListener('dblclick', e => e.preventDefault(), { passive:false });
  document.addEventListener('gesturestart',  e => e.preventDefault(), { passive:false });
  document.addEventListener('gesturechange', e => e.preventDefault(), { passive:false });
  document.addEventListener('gestureend',    e => e.preventDefault(), { passive:false });

  /* --- ajouts JS globaux pour neutraliser s√©lection / context menu / drag --- */
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('selectstart', e => e.preventDefault());
  document.addEventListener('dragstart',   e => e.preventDefault());
  /* ------------------------------------------------------------------------- */

  render();
</script>
</body>
</html>
